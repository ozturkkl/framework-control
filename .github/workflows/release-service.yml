name: Build and Release Service MSI

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-msi:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: service
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine version change
        id: version_check
        shell: pwsh
        working-directory: .
        run: |
          $ErrorActionPreference = 'Stop'
          $sha = $env:GITHUB_SHA
          $parentSha = git rev-parse "$sha^"
          $diff = git diff -U0 "$parentSha" "$sha" -- service/Cargo.toml
          if (-not $diff) {
            echo "SHOULD_RELEASE=false" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "service/Cargo.toml not changed; skipping release."
            exit 0
          }
          $prevMatch = ($diff -split "`n") | Select-String '^-version\s*=\s*"([^"]+)"' | Select-Object -First 1
          $currMatch = ($diff -split "`n") | Select-String '^\+version\s*=\s*"([^"]+)"' | Select-Object -First 1
          if (-not $prevMatch) { throw "Could not find previous version in diff" }
          if (-not $currMatch) { throw "Could not find current version in diff" }
          $previous = $prevMatch.Matches[0].Groups[1].Value
          $current = $currMatch.Matches[0].Groups[1].Value
          $shouldRelease = ($previous -and $current -and ($current -ne $previous))
          $isPrerelease = $current -match '-'
          echo "VERSION=$current" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "SHOULD_RELEASE=$shouldRelease" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "IS_PRERELEASE=$isPrerelease" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Current version: $current"
          Write-Host "Previous version: $previous"
          Write-Host "Should release: $shouldRelease"
          Write-Host "Is pre-release: $isPrerelease"

      - name: Install Rust (stable)
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            service/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('service/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install WiX Toolset
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: choco install wixtoolset --no-progress -y

      - name: Setup Node.js 20
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Build MSI
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: node scripts/build-msi.mjs
        env:
          GITHUB_PAGES: "false"
          VITE_BASE: "/"
          VITE_API_BASE: ${{ secrets.VITE_API_BASE || vars.VITE_API_BASE }}
          VITE_INSTALLER_URL: ${{ secrets.VITE_INSTALLER_URL || vars.VITE_INSTALLER_URL }}
          VITE_CONTROL_TOKEN: ${{ secrets.VITE_CONTROL_TOKEN || vars.VITE_CONTROL_TOKEN }}
          FRAMEWORK_CONTROL_PORT: ${{ secrets.FRAMEWORK_CONTROL_PORT || vars.FRAMEWORK_CONTROL_PORT }}
          FRAMEWORK_CONTROL_TOKEN: ${{ secrets.FRAMEWORK_CONTROL_TOKEN || vars.FRAMEWORK_CONTROL_TOKEN }}
          FRAMEWORK_CONTROL_ALLOWED_ORIGINS: ${{ secrets.FRAMEWORK_CONTROL_ALLOWED_ORIGINS || vars.FRAMEWORK_CONTROL_ALLOWED_ORIGINS }}
          FRAMEWORK_CONTROL_UPDATE_REPO: ${{ secrets.FRAMEWORK_CONTROL_UPDATE_REPO || vars.FRAMEWORK_CONTROL_UPDATE_REPO }}
        working-directory: web

      - name: Locate MSI and read version
        shell: pwsh
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: |
          $ErrorActionPreference = 'Stop'
          $msi = Get-ChildItem -Path "target/wix" -Filter *.msi | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $msi) { throw "MSI not found in target/wix" }
          echo "MSI_PATH=$($msi.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "STABLE_NAME=framework-control-service-x86_64.msi" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create stable-named copy for upload
        shell: pwsh
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: |
          $ErrorActionPreference = 'Stop'
          $stable = Join-Path $env:RUNNER_TEMP $env:STABLE_NAME
          Copy-Item -Path "$env:MSI_PATH" -Destination "$stable" -Force
          echo "STABLE_PATH=$stable" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Generate SHA256
        shell: pwsh
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: |
          $ErrorActionPreference = 'Stop'
          $hash = (Get-FileHash "$env:MSI_PATH" -Algorithm SHA256).Hash
          $shaPath = "$env:RUNNER_TEMP/" + $env:STABLE_NAME + ".sha256"
          Set-Content -Path $shaPath -Value $hash -NoNewline
          echo "SHA_PATH=$shaPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Ensure gh CLI
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        run: gh --version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish versioned release for bumped version
        if: env.SHOULD_RELEASE == 'True' || env.SHOULD_RELEASE == 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "$env:VERSION"
          $changelogPath = "../CHANGELOG.md"
          $defaultBody = "Refer to the CHANGELOG.md for information about version $env:VERSION."
          $body = $defaultBody
          if (Test-Path $changelogPath) {
            $lines = Get-Content $changelogPath
            $pattern = ('^##\s+' + [regex]::Escape($env:VERSION) + '(\s|$)')
            $match = ($lines | Select-String -Pattern $pattern | Select-Object -First 1)
            if ($match) {
              $startIndex = [int]$match.LineNumber - 1  # Convert to 0-based index
              $after = $lines[$startIndex..($lines.Length-1)]
              $headers = ($after | Select-String -Pattern '^##\s+' -AllMatches)
              if ($headers.Count -ge 2) {
                $endIndex = [int]$headers[1].LineNumber - 2
              } else {
                $endIndex = $after.Length - 1
              }
              if ($endIndex -ge 0) {
                $section = $after[0..$endIndex]
                $body = ($section -join "`n")
              }
            }
          }
          $isPrerelease = $env:IS_PRERELEASE -eq 'True' -or $env:IS_PRERELEASE -eq 'true'
          $prereleaseFlag = if ($isPrerelease) { "--prerelease" } else { "--latest" }
          gh release view $tag 2>$null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag -t "Framework Service Installer" -n "$body" $prereleaseFlag
          } else {
            gh release edit $tag -t "Framework Service Installer" -n "$body" $prereleaseFlag
          }
          gh release upload $tag "$env:STABLE_PATH" --clobber
          gh release upload $tag "$env:SHA_PATH" --clobber

  build-linux:
    needs: build-msi
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: service
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine version change
        id: version_check
        shell: bash
        working-directory: .
        run: |
          set -euo pipefail
          sha="${GITHUB_SHA}"
          parentSha=$(git rev-parse "$sha^" 2>/dev/null || echo "")
          if [ -z "$parentSha" ]; then
            echo "No parent commit; skipping release."
            echo "SHOULD_RELEASE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          diff=$(git diff -U0 "$parentSha" "$sha" -- service/Cargo.toml)
          if [ -z "$diff" ]; then
            echo "SHOULD_RELEASE=false" >> "$GITHUB_ENV"
            echo "service/Cargo.toml not changed; skipping release."
            exit 0
          fi
          previous=$(echo "$diff" | grep -m1 '^-version\s*=' | sed -E 's/^-version\s*=\s*"([^"]+)".*/\1/')
          current=$(echo "$diff" | grep -m1 '^\+version\s*=' | sed -E 's/^\+version\s*=\s*"([^"]+)".*/\1/')
          if [ -n "$previous" ] && [ -n "$current" ] && [ "$current" != "$previous" ]; then
            shouldRelease=true
          else
            shouldRelease=false
          fi
          isPrerelease=false
          if echo "$current" | grep -q '-'; then
            isPrerelease=true
          fi
          echo "VERSION=$current" >> "$GITHUB_ENV"
          echo "SHOULD_RELEASE=$shouldRelease" >> "$GITHUB_ENV"
          echo "IS_PRERELEASE=$isPrerelease" >> "$GITHUB_ENV"
          echo "Current version: $current"
          echo "Previous version: $previous"
          echo "Should release: $shouldRelease"
          echo "Is pre-release: $isPrerelease"

      - name: Install Rust (stable)
        if: env.SHOULD_RELEASE == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Cache Cargo registry and build
        if: env.SHOULD_RELEASE == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            service/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('service/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install musl-tools
        if: env.SHOULD_RELEASE == 'true'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Setup Node.js 20
        if: env.SHOULD_RELEASE == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Build Linux tarball
        if: env.SHOULD_RELEASE == 'true'
        run: node scripts/build-linux.mjs
        env:
          STATIC_BUILD: "true"
          GITHUB_PAGES: "false"
          VITE_BASE: "/"
          VITE_API_BASE: ${{ secrets.VITE_API_BASE || vars.VITE_API_BASE }}
          VITE_INSTALLER_URL: ${{ secrets.VITE_INSTALLER_URL || vars.VITE_INSTALLER_URL }}
          VITE_CONTROL_TOKEN: ${{ secrets.VITE_CONTROL_TOKEN || vars.VITE_CONTROL_TOKEN }}
          FRAMEWORK_CONTROL_PORT: ${{ secrets.FRAMEWORK_CONTROL_PORT || vars.FRAMEWORK_CONTROL_PORT }}
          FRAMEWORK_CONTROL_TOKEN: ${{ secrets.FRAMEWORK_CONTROL_TOKEN || vars.FRAMEWORK_CONTROL_TOKEN }}
          FRAMEWORK_CONTROL_ALLOWED_ORIGINS: ${{ secrets.FRAMEWORK_CONTROL_ALLOWED_ORIGINS || vars.FRAMEWORK_CONTROL_ALLOWED_ORIGINS }}
          FRAMEWORK_CONTROL_UPDATE_REPO: ${{ secrets.FRAMEWORK_CONTROL_UPDATE_REPO || vars.FRAMEWORK_CONTROL_UPDATE_REPO }}
        working-directory: web

      - name: Locate tarball and generate SHA256
        if: env.SHOULD_RELEASE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tarballName="framework-control-${VERSION}-linux-x86_64.tar.gz"
          tarballPath="target/$tarballName"
          if [ ! -f "$tarballPath" ]; then
            echo "Tarball not found: $tarballPath"
            exit 1
          fi
          hash=$(sha256sum "$tarballPath" | awk '{print $1}')
          sha_file="${tarballPath}.sha256"
          echo -n "$hash" > "$sha_file"
          echo "TARBALL_PATH=$tarballPath" >> "$GITHUB_ENV"
          echo "SHA_PATH=$sha_file" >> "$GITHUB_ENV"
          echo "Found tarball: $tarballPath"

      - name: Ensure gh CLI
        if: env.SHOULD_RELEASE == 'true'
        run: gh --version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Linux assets to release
        if: env.SHOULD_RELEASE == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="$VERSION"
          if ! gh release view "$tag" 2>/dev/null; then
            echo "Release $tag does not exist yet; Windows job should create it first"
            exit 1
          fi
          gh release upload "$tag" "$TARBALL_PATH" --clobber
          gh release upload "$tag" "$SHA_PATH" --clobber
